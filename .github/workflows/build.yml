name: Build Full App APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # üîß 1. –ü–†–û–°–¢–û–ô –ò –ù–ê–î–Å–ñ–ù–´–ô –°–ü–û–°–û–ë: GitHub Actions —É–∂–µ –∏–º–µ–µ—Ç Android SDK
      #    –ù–∞–º –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω—è—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π CMake
      - name: Setup Android SDK
        run: |
          echo "üõ†Ô∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Android SDK..."
          
          # –ü—Ä–∏–Ω–∏–º–∞–µ–º –≤—Å–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          echo "‚úÖ –õ–∏—Ü–µ–Ω–∑–∏–∏ –ø—Ä–∏–Ω—è—Ç—ã"
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û CMake 3.22.1 (–∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±–æ–≤–∞–ª—Å—è –≤ –æ—à–∏–±–∫–µ)
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é CMake 3.22.1..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "cmake;3.22.1"
          echo "‚úÖ CMake —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Clean and get dependencies
        run: |
          echo "üßπ –û—á–∏—â–∞—é –ø—Ä–æ–µ–∫—Ç..."
          flutter clean
          rm -rf $HOME/.gradle/caches/
          flutter pub get
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      # üèóÔ∏è 2. –°–±–æ—Ä–∫–∞ –¢–û–õ–¨–ö–û –¥–ª—è ARM64 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏)
      - name: Build APK (ARM64 only)
        env:
          # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞–º—è—Ç—å –¥–ª—è Java/Gradle
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4608m"
          JAVA_OPTS: "-Xmx4608m"
        run: |
          echo "üîÑ –°–æ–±–∏—Ä–∞—é APK (—Ç–æ–ª—å–∫–æ ARM64)..."
          
          # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: --target-platform android-arm64
          flutter build apk --release \
            --no-tree-shake-icons \
            --target-platform android-arm64 \
            --verbose
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
          echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç:"
          ls -la build/app/outputs/apk/release/

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: tension-ceiling-app-apk
          path: build/app/outputs/apk/release/app-release.apk
          retention-days: 14
