name: Build Full App APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17 with more memory
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞–º—è—Ç—å –¥–ª—è Java
          java-package: jdk
          architecture: x64

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
          packages: |
            platform-tools
            platforms;android-36
            build-tools;34.0.0
            cmdline-tools;latest
            cmake;3.22.1
            ndk;25.1.8937393

      - name: Accept Android Licenses
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          echo "‚úÖ –õ–∏—Ü–µ–Ω–∑–∏–∏ –ø—Ä–∏–Ω—è—Ç—ã"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Clean and get dependencies
        run: |
          echo "üßπ –û—á–∏—â–∞—é –∫—ç—à —Å–±–æ—Ä–∫–∏..."
          # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫—ç—à–µ–π
          flutter clean
          rm -rf $HOME/.gradle/caches/
          rm -rf build/
          rm -rf android/.gradle/
          
          echo "üì¶ –ü–æ–ª—É—á–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          flutter pub get
          
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
          flutter --version
          echo "compileSdkVersion: $(grep 'compileSdkVersion' android/app/build.gradle)"

      # üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ô –®–ê–ì: –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è arm64
      - name: Build APK (ARM64 only)
        env:
          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–ª—è Gradle
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4608m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError"
          # –û—Ç–∫–ª—é—á–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          GRADLE_MAX_WORKERS: 2
        run: |
          echo "üîÑ –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É APK (—Ç–æ–ª—å–∫–æ ARM64)..."
          
          # –°–æ–±–∏—Ä–∞–µ–º –¢–û–õ–¨–ö–û –¥–ª—è ARM64 - —ç—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –Ω–∞ 70%
          flutter build apk --release \
            --no-tree-shake-icons \
            --split-debug-info=/tmp/symbols \
            --obfuscate \
            --target-platform android-arm64
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            echo "‚úÖ APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
            echo "üìä –†–∞–∑–º–µ—Ä APK: $(du -h build/app/outputs/apk/release/app-release.apk | cut -f1)"
            echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            ls -la build/app/outputs/apk/release/
          else
            echo "‚ùå APK –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: tension-ceiling-app-apk
          path: build/app/outputs/apk/release/app-release.apk
          retention-days: 14
